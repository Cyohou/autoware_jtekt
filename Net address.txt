
pose+twist，高频 INS 外推	LRF（硬件/首帧/ENU）	GNSS 好时长期不漂，差时随基准漂移
提升 nav_sat_fix 率 + twist 融合				/ins/imu	Imu	姿态、角速度、加速度	ENU/IMU frame	姿态来自 INS 解算
做法：硬件支持下把 fix 率调至 5–10 Hz；EKF 用“低频 pose + 高频 twist”。				/ins/velocity	TwistStamped	INS 速度	INS frame	-
优点：简单、信息真实。								
限制：受硬件约束；仍需延迟补偿与协方差治理。								
纯提频（不建议单用）				EKFLocalizer 启动配置				
做法：仅软件加大发布率而无更高真实测量频率。				参数	作用	典型值/要求		
问题：重复/插值信息，收益有限，可能放大延迟与噪声。				input_pose_with_cov_name	位姿观测输入话题	remap 到 /localization/pose_estimator/pose_with_covariance		
OxTS ROS2 驱动与参考系				input_twist_with_cov_name	速度观测输入话题	remap 到 /localization/twist_estimator/twist_with_covariance		
关键输出话题（前缀示例：/ins）				pose_frame_id	位姿观测 frame	map		
绝对类				pose_additional_delay / twist_additional_delay	延迟补偿	GNSS 常 0.1–0.3 s		
/ins/nav_sat_fix: WGS84 位置，协方差来自 EastAcc/NorthAcc/AltAcc。				pose_smoothing_steps / twist_smoothing_steps	平滑步数	pose 5，twist 2		
/ins/nav_sat_ref: 本地参考原点（LRF）信息。				pose_gate_dist / twist_gate_dist	马氏距离门限	典型 10000.0（需调优）		
融合/高频类				proc_stddev_yaw_c / vx_c / wz_c	过程噪声（连续）	yaw 0.005，vx 5.0，wz 1.0		
/ins/odometry: 本地参考系下的 pose+twist，频率 50–200 Hz。				predict_frequency	EKF 主循环频率	50 Hz		
Pose: GNSS 绝对解投影到 LRF + IMU 外推；GNSS 差时可能随基准漂移。				tf_rate	TF 发布频率	10 Hz		
Twist: 来自 INS 解算的速度与角速度。								
传感器原始类								
/ins/imu, /ins/velocity, /ins/lever_arm, /ins/time_reference 等。				EKF 状态与数据流				
LRF（本地参考系）来源				阶段	输入	处理	输出	
硬件 LRF（推荐，重启不变，适合长期运行）				预测	上一状态 + twist	运动学模型预测（vx,wz）	预测状态 X_next	
首帧位置+航向				位姿更新	pose_with_cov	延迟补偿 → yaw 归一化 → 马氏距离门控 → updateWithDelay	修正 x,y,yaw	
首帧位置 + ENU 对齐				速度更新	twist_with_cov	延迟补偿 → 马氏距离门控 → updateWithDelay	修正 vx,wz	
建议：使用硬件 LRF，确保 map 原点固定与一致（避免重启漂移）。				发布	EKF 状态 + 协方差	组装 Pose/Twist/Odom/TF	/ekf_pose、/ekf_twist、/ekf_odom 等	
EKFLocalizer 启动配置与数据流								
启动文件要点								
输入 remap				输入话题数据格式要求				
in_pose_with_covariance ← 你的 /localization/pose_estimator/pose_with_covariance				话题	类型	frame_id	必填字段	协方差要求
in_twist_with_covariance ← 你的 /localization/twist_estimator/twist_with_covariance				/localization/pose_estimator/pose_with_covariance	PoseWithCovarianceStamped	map（或配置值）	position.x/y/z，orientation（四元数）	至少 X、Y、Yaw 方差准确
关键参数				/localization/twist_estimator/twist_with_covariance	TwistWithCovarianceStamped	base_link	linear.x（vx），angular.z（wz）	至少 vx、wz 方差准确
预测与 TF：predict_frequency、tf_rate								
延迟补偿：pose_additional_delay、twist_additional_delay								
平滑：pose_smoothing_steps、twist_smoothing_steps				工程落地与验证要点				
门控：pose_gate_dist、twist_gate_dist				类别	要点			
过程噪声（离散化前的连续参数）：proc_stddev_yaw_c、proc_stddev_vx_c、proc_stddev_wz_c				协方差治理	动态调整：FIX 小、FLOAT 中、单点/遮挡 大或拒收			
帧：pose_frame_id（通常为 map）				延迟补偿	设置 pose/twist_additional_delay，使用测量时间戳			
初始位姿与触发：initialpose、trigger_node_srv				门控	启用马氏距离门控，超阈值拒收观测			
EKF 状态与输出				参考系	固定 map 原点（硬件 LRF），杆臂 TF 准确			
状态向量（6 维）：[x, y, yaw, yaw_bias, vx, wz]				验证	创新量有界；pose 微分≈twist；fix 到来无大跳变；退化后快速恢复			
roll、pitch、z 通过 1D 滤波器从 pose 观测中平滑更新								
输出								
ekf_pose(_with_covariance)（map）								
ekf_twist(_with_covariance)（base_link）								
ekf_odom（map→base_link）								
estimated_yaw_bias、debug 话题								
TF：map → base_link								
主循环（timerCallback）								
预测：用上次状态 + vx,wz 的运动学预测（A,Q 基于 proc_stddev 与 dt）								
更新								
Pose：延迟补偿→yaw 归一化→马氏距离门控→updateWithDelay								
Twist：延迟补偿→马氏距离门控→updateWithDelay								
两个输入话题的数据格式要求								
/localization/pose_estimator/pose_with_covariance								
类型：geometry_msgs/PoseWithCovarianceStamped								
必要字段								
header.frame_id：必须等于 EKF 的 pose_frame_id（通常 map）								
header.stamp：测量时刻（非接收时刻）								
pose.pose.position：x/y/z（z 用于 1D 滤波）								
pose.pose.orientation：四元数（EKF 使用 yaw；z/roll/pitch 进入 1D 滤波）								
pose.covariance：6×6（至少 X、Y、Yaw 方差准确）								
处理								
延迟补偿：stamp + pose_additional_delay → delay_step								
门控：马氏距离阈值 pose_gate_dist								
/localization/twist_estimator/twist_with_covariance								
类型：geometry_msgs/TwistWithCovarianceStamped								
必要字段								
header.frame_id：必须为 base_link								
header.stamp：测量时刻								
twist.twist.linear.x：vx								
twist.twist.angular.z：wz								
twist.covariance：6×6（至少 vx、wz 方差准确）								
处理								
延迟补偿：stamp + twist_additional_delay → delay_step								
门控：马氏距离阈值 twist_gate_dist								
工程落地与验证清单								
接线模式								
基线稳妥（推荐）								
软位姿：odometry.pose → pose_with_cov（协方差大）								
硬位姿：GNSS fix→pose_with_cov（协方差小，动态随 FIX/FLOAT/HDOP 调整）								
预测：odometry.twist → twist_with_cov								
极简高性能（GNSS 全程优）								
odometry.pose + odometry.twist 双高频输入，按 GNSS 质量动态调 pose 协方差								
仍建议保留硬锚定低频注入作为保险								
协方差与门控								
动态协方差（强烈建议）								
FIX：XY 方差小（例如 0.03–0.08 m 的平方级）								
FLOAT：中等								
单点/遮挡：大，必要时拒收								
创新/马氏距离门限								
超阈值拒收该帧，避免多路径/跳变污染								
延迟与时间								
pose_additional_delay/twist_additional_delay：补偿 0.1–0.3 s 常见 GNSS 延迟								
严格使用测量时间戳（非接收时间）								
超出 extend_state_step * dt 的延迟将被丢弃								
参考系与标定								
固定 map 原点（硬件 LRF，重启不变）								
准确的杆臂（lever arm）与 TF								
速度 frame 要求 base_link								
所有 pose 观测 frame_id 一致（= pose_frame_id）								
验证指标								
创新量/马氏距离：长期有界，无系统性偏移								
一致性：输出 pose 的时间微分 ≈ twist								
fix 到来时无大“抽回”								
瞬时退化后恢复快速、无残留偏差								
记录拒收率与延迟阶数，排查边界工况								
