Localization Pipeline		
ローカライゼーションチェーン		
GNSS/NDTの姿勢 + Twist → EKF → /pose & /twist → /pose（知覚結果を base_link から map に変換）		
ノード名	購読トピック	発行トピック
/localization/pose_estimator/ndt_scan_matcher	/sensing/gnss/pose_with_covariance	/localization/pose_estimator/pose
	/map/pointcloud_map	/localization/pose_estimator/pose_with_covariance
	/localization/util/downsample/pointcloud	
	/localization/pose_twist_fusion_filter/biased_pose_with_covariance	
/localization/pose_twist_fusion_filter/ekf_localizer	/initialpose3d	/localization/pose_twist_fusion_filter/pose
	/localization/pose_estimator/pose_with_covariance	/localization/pose_twist_fusion_filter/twist
	/localization/twist_estimator/twist_with_covariance	/localization/pose_twist_fusion_filter/twist_with_covariance
		/localization/pose_twist_fusion_filter/kinematic_state
/pose_initializer/pose_initializer_node	/sensing/gnss/pose_with_covariance	/initialpose3d
	/sensing/vehicle_velocity_converter/twist_with_covariance	/localization/initialization_state
		
Twist Pipeline		
速度チェーン		
/vehicle/status/velocity_status → /sensing/vehicle_velocity_converter/twist_with_covariance → /localization/twist_estimator/twist_with_covariance → EKF		
ノード名	購読トピック	発行トピック
/vehicle_velocity_converter	/vehicle/status/velocity_status	/sensing/vehicle_velocity_converter/twist_with_covariance
/localization/twist_estimator/gyro_odometer	/sensing/vehicle_velocity_converter/twist_with_covariance	/localization/twist_estimator/twist_with_covariance
		/localization/twist_estimator/twist_with_covariance_raw
/localization/pose_twist_fusion_filter/stop_filter	/localization/pose_twist_fusion_filter/kinematic_state	/localization/kinematic_state
	/localization/pose_twist_fusion_filter/twist_with_covariance	
/localization/pose_twist_fusion_filter/twist2accel	/localization/kinematic_state	/localization/acceleration
	/localization/twist_estimator/twist_with_covariance	
		
GNSS / INS モジュール		
ノード名	購読トピック	発行トピック
GNSSドライバ（OXTS）	なし（ハードウェアドライバ）	/sensing/gnss/pose_with_covariance
		/sensing/gnss/pose
		/sensing/gnss/ins/odometry
		/sensing/gnss/ins/path
		/sensing/gnss/ins/imu
		/sensing/gnss/ins/nav_sat_fix
		/sensing/gnss/fixed
		
項目	長所	短所・リスク
GNSSデータソース（OxTS）	ハードウェアが高頻度NCOMを出力、oxts_insが /nav_sat_fix、/odometry、/imu などを計算	RTK FIX時は0.1–0.2m精度、INSは低速でも安定した姿勢
gnss_poser	/nav_sat_fix をmap座標系に変換、姿勢を融合し /sensing/gnss/pose(_with_covariance) を出力	共分散付きのグローバル姿勢を提供、frame_id=map
NDT（正則化なし）	点群マッチングで /ndt_pose(_with_covariance) を出力	特徴が豊富な場面では高精度、横・縦方向とも安定
NDT正則化	NDTコスト関数に縦方向制約を追加、基準は /sensing/gnss/pose_with_covariance	開けた場面で縦方向ドリフトを抑制、GNSSが良好なら縦精度はGNSS並み
正則化の適用場面	橋、高速道路、農道など特徴が少なくGNSSが使える場面	GNSSが安定していれば長期的に固定可能
/localization/pose_estimator への出力	正則化後のNDT出力を /localization/pose_estimator/pose(_with_covariance) にリマップ	下流のEKFや制御が直接使用可能
		
コア結論		
次元	GNSS-onlyモード	NDT正則化モード
主なローカライゼーションソース	GNSS pose_with_covariance	NDT pose_with_covariance（縦方向はGNSS制約）
横方向精度	GNSS精度に依存（RTK FIXで0.1–0.2m）	NDTマッチングに依存（特徴が弱いとドリフト）
縦方向精度	GNSS精度に依存	GNSSで固定され、通常安定
地図依存性	なし	あり（点群地図が必要）
遮蔽耐性	弱（GNSS信号が悪いと劣化）	中（NDTが短時間耐える）
実装の複雑さ	低（リマップ + EKF融合）	高（NDTパラメータと正則化調整が必要）
解決策：		
EKFでGNSSの全方向姿勢を融合		
NDTでXY方向も制約		
NDTスコアが低い場合はGNSS-onlyに切替		
		
融合戦略とトレードオフ		
シーン	方法	長所
高頻度オドメトリ分離（推奨）	/odometry.pose → pose_with_cov、/odometry.twist → twist_with_cov、共分散はGNSS品質に応じて動的調整	高頻度・低遅延、poseとtwistが同期、EKF安定
nav_sat_fixレート向上 + twist融合	GNSS解算レートを5–10Hzに向上、低頻度pose + 高頻度twist	シンプルで情報が正確
単純なレート向上（非推奨）	ソフトウェアでfix発行レートを向上	実装が簡単
		
OxTS ROS2ドライバの主要出力		
トピック	型	内容
/ins/nav_sat_fix	NavSatFix	WGS84絶対位置、共分散はEastAcc/NorthAcc/AltAccから
/ins/nav_sat_ref	NavSatRef	ローカル参照原点（LRF）
/ins/odometry	Odometry	LRF座標系のpose+twist、高頻度INS外挿
/ins/imu	Imu	姿勢、角速度、加速度
/ins/velocity	TwistStamped	INS速度
		
EKFLocalizer起動設定		
パラメータ	役割	典型値・要件
input_pose_with_cov_name	姿勢観測入力トピック	/localization/pose_estimator/pose_with_covariance にリマップ
input_twist_with_cov_name	速度観測入力トピック	/localization/twist_estimator/twist_with_covariance にリマップ
pose_frame_id	姿勢観測のframe	map
pose_additional_delay / twist_additional_delay	遅延補償	GNSSは通常0.1–0.3秒
pose_smoothing_steps / twist_smoothing_steps	平滑化ステップ数	pose: 5、twist: 2
pose_gate_dist / twist_gate_dist	マハラノビス距離のゲート閾値	典型値: 10000.0（要調整）
proc_stddev_yaw_c / vx_c / wz_c	プロセスノイズ（連続）	yaw: 0.005、vx: 5.0、wz: 1.0
predict_frequency	EKF主ループ周波数	50Hz
tf_rate	TF発行周波数	10Hz
		
EKF状態とデータフロー		
段階	入力	処理
予測	前回状態 + twist	運動モデルによる予測（vx, wz）
姿勢更新	pose_with_cov	遅延補償 → yaw正規化 → マハラノビス距離ゲート → updateWithDelay
速度更新	twist_with_cov	遅延補償 → マハラノビス距離ゲート → updateWithDelay
発行	EKF状態 + 共分散	Pose/Twist/Odom/TFを組み立て
		
入力topicのデータ形式		
トピック	型	frame_id
/localization/pose_estimator/pose_with_covariance	PoseWithCovarianceStamped	map（または設定値）
/localization/twist_estimator/twist_with_covariance	TwistWithCovarianceStamped	base_link
